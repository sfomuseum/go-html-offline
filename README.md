# go-html-offline

Tools for making HTML files service-worker (offline) ready.

## Install

You will need to have both `Go` (specifically a version of Go more recent than 1.7 so let's just assume you need [Go 1.12](https://golang.org/dl/) or higher) and the `make` programs installed on your computer. Assuming you do just type:

```
make bin
```

All of this package's dependencies are bundled with the code in the `vendor` directory.

## Example

```
import (
	"github.com/sfomuseum/go-html-offline"
)

html_path := "/path/to/index.html"

opts := offline.DefaultServiceWorkerOptions()
offline.AddServiceWorkerToFile(html_path, opts)
```

The `AddServiceWorkerToFile` method is a helper method, working with atomic files, around the more abstract `AddServiceWorker` method that assumes `io.Reader` and `io.Writer` interfaces:

```
import (
	"github.com/sfomuseum/go-html-offline"
	"os"
)

html_path := "/path/to/index.html"

html_in, _ := os.Open(html_path)
html_out := os.Stdout			// update to point to service worker javascript
sw_out := os.Stdout			// the actual service worker javascript

opts := offline.DefaultServiceWorkerOptions()
offline.AddServiceWorker(html_in, html_out, sw_out, opts)
```

_Note that error handling has been removed for the sake of brevity._

The `AddServiceWorker` methods will update the HTML markup, reading from the `html_in` and writing to the `html_out` interfaces, to include the following JavaScript content:

```
<script type="text/javascript" x-service-worker="true">

// this code was added by robots on 2019-03-12T16:07:05-07:00
// https://github.com/sfomuseum/go-html-offline

window.addEventListener("load", function load(event){

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(function(registration) {
    console.log('Service worker registration succeeded:', registration);
  }, /*catch*/ function(error) {
    console.log('Service worker registration failed:', error);
  });
} else {
  console.log('Service workers are not supported.');
}

}, false);

</script>
```

It will also write the following JavaScript to the `sw_out` `io.Writer` interface. The array of URLs passed to the JavaScript `cache.addAll` method are determined from the body of the `html_in` HTML file.

```
// this file was generated by robots on 2019-03-12T16:07:05-07:00
// https://github.com/sfomuseum/go-html-offline

var CACHE = 'network-or-cache';

self.addEventListener('install', function(evt) {
  console.log('The service worker is being installed.');
  evt.waitUntil(precache());
});

self.addEventListener('fetch', function(evt) {
  console.log('The service worker is serving the asset.');
  evt.respondWith(fromNetwork(evt.request, 400).catch(function () {
    return fromCache(evt.request);
  }));
});

function precache() {
  return caches.open(CACHE).then(function (cache) {
    return cache.addAll([
	'./',
	'./index.html',
	...other assets in html_path
    ]);
  });
}

function fromNetwork(request, timeout) {
  return new Promise(function (fulfill, reject) {
    var timeoutId = setTimeout(reject, timeout);
    fetch(request).then(function (response) {
      clearTimeout(timeoutId);
      fulfill(response);
    }, reject);
  });
}

function fromCache(request) {
  return caches.open(CACHE).then(function (cache) {
    return cache.match(request).then(function (matching) {
      if (! matching){
	return Promise.reject('no-match');
      }
      return matching;
    });
  });
}
```

## Tools

### add-service-worker

Add server worker JavaScript handlers for one or more HTML files.

```
./bin/add-service-worker -h
Usage of ./bin/add-service-worker:
  -cache-name string
    	The name for your browser/service worker cache. (default "network-or-cache")
  -mode string
    	Indicate how command line arguments should be interpreted. Valid options are: files, directory. (default "file")
  -server-worker-url string
    	The URI of the JavaScript service worker. (default "sw.js")
```

For example:

```
$> add-service-worker /path/to/index.html
$> ls -al /path/to/index.html
/path/to/index.html
/path/to/sw.js
```

If you just want to bulk process one or more folders full of `.html` files you would invoke `add-service-worker` with the `-mode directory` flag.

### service-worker-inventoryd

```
./bin/service-worker-inventoryd -h
Usage of ./bin/service-worker-inventoryd:
  -cache-name string
    	The name for your browser/service worker cache. (default "network-or-cache")
  -host string
    	The hostname to listen for requests on. (default "localhost")
  -port int
    	The port number to listen for requests on. (default 8080)
  -prefix string
    	A prefix to remove from URLs before fetching subrequests.
  -root string
    	A valid URL to fetch subrequests from
```

For example:

```
$> ./bin/service-worker-inventoryd -prefix "sw/" -root "https://millsfield.sfomuseum.org"
```

And then in another terminal:

```
$> curl localhost:8080/sw/images/1377126959/

// this file was generated by robots on 2019-03-12T18:00:06-07:00
// https://github.com/sfomuseum/go-html-offline

... omitted for the sake of brevity

function precache() {
  return caches.open(CACHE).then(function (cache) {
    return cache.addAll([
	'./',
	'./index.html',
	'https://millsfield.sfomuseum.org/css/collection/sfomuseum-common/bootstrap.4.1.1.min.css',
	'https://millsfield.sfomuseum.org/css/collection/sfomuseum-common/leaflet.css',
	'https://millsfield.sfomuseum.org/css/collection/sfomuseum-common/sfomuseum.millsfield.css',
	'https://millsfield.sfomuseum.org/css/collection/sfomuseum-common/sfomuseum.millsfield.print.css',
	'https://millsfield.sfomuseum.org/css/collection/sfomuseum-common/sfomuseum.millsfield.placetypes.css',
	'https://millsfield.sfomuseum.org/css/collection/sfomuseum.collection.bootstrap.css',
	'https://millsfield.sfomuseum.org/css/collection/sfomuseum.collection.css',
	'https://millsfield.sfomuseum.org/css/collection/sfomuseum-common/sfomuseum.millsfield.leaflet.css',
	'https://millsfield.sfomuseum.org/css/collection/sfomuseum-common/sfomuseum.millsfield.media.css',
	'https://millsfield.sfomuseum.org/css/collection/sfomuseum.collection.media.css',
	'https://millsfield.sfomuseum.org/media/137/712/695/9/1377126959_fORVrjb1WIuTRkNHMDIO9TRDKqv0x3ce_c.jpg',
	'https://millsfield.sfomuseum.org/media/137/712/695/9/1377126959_fORVrjb1WIuTRkNHMDIO9TRDKqv0x3ce_z.jpg',
	'https://millsfield.sfomuseum.org/media/137/712/695/9/1377126959_fORVrjb1WIuTRkNHMDIO9TRDKqv0x3ce_n.jpg',
	'https://millsfield.sfomuseum.org/media/137/712/695/9/1377126959_fORVrjb1WIuTRkNHMDIO9TRDKqv0x3ce_k.jpg',
	'https://millsfield.sfomuseum.org/media/137/712/695/9/1377126959_fORVrjb1WIuTRkNHMDIO9TRDKqv0x3ce_b.jpg',
	'https://millsfield.sfomuseum.org/media/137/712/695/9/1377126959_fORVrjb1WIuTRkNHMDIO9TRDKqv0x3ce_c.jpg',
	'https://millsfield.sfomuseum.org/media/137/712/695/9/1377126959_fORVrjb1WIuTRkNHMDIO9TRDKqv0x3ce_z.jpg',
	'https://millsfield.sfomuseum.org/media/137/712/695/9/1377126959_fORVrjb1WIuTRkNHMDIO9TRDKqv0x3ce_n.jpg',
	'https://millsfield.sfomuseum.org/media/137/712/695/9/1377126959_fORVrjb1WIuTRkNHMDIO9TRDKqv0x3ce_c.jpg',
	'https://millsfield.sfomuseum.org/javascript/collection/sfomuseum.collection.maps.features.init.js',
	'https://millsfield.sfomuseum.org/javascript/collection/sfomuseum.collection.maps.results.init.js',
	
    ]);
  });
}

... omitted for the sake of brevity
```

## URIs

URIs (to be passed to the `cache.addAll` JavaScript function) are derived from the following HTML elements:

* &lt;img src="{URI}" /&gt;
* &lt;link rel="stylesheet" href="{URI}" /&gt;
* &lt;script type="text/javascript" src="{URI}" /&gt;
* &lt;source srcset="{URI}" /&gt;
* &lt;source src="{URI}" /&gt;

## See also

* https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API/Using_Service_Workers
* https://hacks.mozilla.org/2015/11/offline-service-workers/
* https://serviceworke.rs/strategy-network-or-cache_service-worker_doc.html